
#------------------------------------------------------------------------------
#----- TraceWrapper.py ----------------------------------------------------
#------------------------------------------------------------------------------

#-------1---------2---------3---------4---------5---------6---------7---------8
#       01234567890123456789012345678901234567890123456789012345678901234567890
#-------+---------+---------+---------+---------+---------+---------+---------+

# copyright:   2017 WiM - USGS

#    authors:  Jeremy K. Newson USGS Web Informatics and Mapping
# 
#   purpose:  Wrapper to delineate watershed using split catchement methods
#          
#discussion:  
#       

#region "Comments"
#09.20.2017 jkn - Created
#endregion

#region "Imports"
import traceback
import datetime
import time
import os
import arcpy
from arcpy import env
from arcpy.sa import *
from WiMPy import WiMLogging
from WiMPy import Shared
from WiMPy import GeoJsonHandler
from WiMPy.MapLayer import *
from WiMPy.Config import Config
import json
import numpy as np
from FlowDirectionTrace import FlowDirectionTrace

#endregion

##-------1---------2---------3---------4---------5---------6---------7---------8
##       Main
##-------+---------+---------+---------+---------+---------+---------+---------+

#http://stackoverflow.com/questions/13653991/passing-quotes-in-process-start-arguments
class TraceWrapperScript(object):
    #region Constructor
    def __init__(self):
        mask = None
        spoint = None
        traceline = None
        try:
            
            arcpy.AddMessage("reading from arcpy")
            isARCProcess = True
            startpoint = arcpy.GetParameterAsText(0)  
            outsrid = arcpy.GetParameterAsText(1)  
            maskjson = arcpy.GetParameterAsText(2)  

            if startpoint == '' or not startpoint:
                startpoint ='{"type":"Feature","geometry":{"type":"Point","coordinates":[-113.60172271728517, 41.165473971527646]}}'
            if outsrid == '' or not outsrid:
                outsrid = '4326'
            if maskjson == '' or not maskjson:
                maskjson ='''{"type":"FeatureCollection","totalFeatures":1,"features":[{"type":"Feature","id":"catchmentsp.2198748","geometry":{"type":"MultiPolygon","coordinates":[[[[-113.68146425999998,41.1269158240652],[-113.68205992799996,41.12693891306522],[-113.68321502999999,41.127317130065215],[-113.684106204,41.12665233306519],[-113.68464980999993,41.126469689065246],[-113.68761013599999,41.12722659406519],[-113.69202179099995,41.12781204006519],[-113.69367948699995,41.12822412606523],[-113.69535962799996,41.128521213065206],[-113.70034027999999,41.129871271065205],[-113.70465646599996,41.13088083406518],[-113.70722588099994,41.133121537065215],[-113.708224772,41.13505736906516],[-113.710152645,41.13799727406515],[-113.71231286199996,41.14218062206516],[-113.71535431099994,41.14640440406514],[-113.71677339899998,41.147668846065116],[-113.71760307399995,41.14802644506514],[-113.71918618599996,41.14914110806509],[-113.72295136199996,41.153962048065075],[-113.72345025599999,41.154426755065124],[-113.72431398199997,41.155313201065105],[-113.72870134699996,41.15778007206506],[-113.73001968699998,41.15869642306506],[-113.73178142499997,41.15980190506506],[-113.73205312299996,41.160178123065045],[-113.72990881599996,41.1603193530651],[-113.72821428199997,41.160663715065056],[-113.72594113899999,41.16038197306509],[-113.72185175599998,41.16121249106508],[-113.72096394899997,41.160496629065086],[-113.72016651699994,41.16035712106507],[-113.71877142299998,41.15986047106507],[-113.71831488699996,41.15921831006509],[-113.71560698999996,41.15826668406509],[-113.71520183499996,41.1580359160651],[-113.71173000299996,41.15812123606508],[-113.711016246,41.15755453906506],[-113.71021766599996,41.15665888706507],[-113.70871176699995,41.15569624206512],[-113.70643883499997,41.153803678065124],[-113.705986597,41.15362422606512],[-113.70501097999995,41.153001553065124],[-113.70207940799997,41.15184353606511],[-113.69990854399998,41.15281134606512],[-113.70005047299996,41.15313975006508],[-113.69940582699998,41.153698739065085],[-113.69946123899994,41.15663070106507],[-113.69874891999994,41.15818333606506],[-113.69841551399999,41.15847289906508],[-113.69812936299996,41.15945775406509],[-113.69729147199997,41.16111424506509],[-113.69712475999995,41.16125902506506],[-113.69651045699999,41.16100531406509],[-113.69569204799996,41.159584070065065],[-113.69375350799997,41.158908743065055],[-113.69191781299996,41.158865506065055],[-113.69118380199995,41.158059777065084],[-113.69054899399998,41.157668324065064],[-113.68817607999995,41.15699092206512],[-113.68767021599994,41.15643548306508],[-113.68644763699997,41.156086912065064],[-113.68578714299997,41.154790517065074],[-113.68367341299997,41.15474030906513],[-113.68264020999997,41.15294437706508],[-113.680983944,41.15330937306511],[-113.68016101199999,41.15309652406513],[-113.67605761299997,41.15335557506513],[-113.67483645099999,41.15362338406511],[-113.673003672,41.15357948906508],[-113.67239157099998,41.153713059065076],[-113.67163532599994,41.153401362065104],[-113.67071738099997,41.1528353690651],[-113.67008244299996,41.15371659706512],[-113.66986090399996,41.1544430700651],[-113.66913245799996,41.15585498806507],[-113.66721915499994,41.1557306710651],[-113.66605385099996,41.15598737806511],[-113.66370777199995,41.1556807050651],[-113.66002279099996,41.155912653065116],[-113.65904582999998,41.156126984065104],[-113.65784772499995,41.155970704065105],[-113.65726297999998,41.15609930606508],[-113.65333824699997,41.1561078980651],[-113.65277968299995,41.15685585706507],[-113.65201840199995,41.15753841806508],[-113.65316054199998,41.15825532306507],[-113.65407161299997,41.1584091650651],[-113.65453189099996,41.15891569206507],[-113.65547258799994,41.15973635406508],[-113.65531857099995,41.16044163006505],[-113.65483166899996,41.160878179065065],[-113.65426754999999,41.16208594806509],[-113.65492245599997,41.16312442106508],[-113.65604451499998,41.16331374006503],[-113.65657140699993,41.16408360706506],[-113.657730933,41.16456269306504],[-113.65838049199999,41.16619726706507],[-113.65793920299996,41.16659337106507],[-113.65713331399996,41.16767200006502],[-113.65602295199993,41.16837354806506],[-113.65544716599999,41.16832834006505],[-113.65342427399997,41.16763544906502],[-113.64793850599996,41.16667227406504],[-113.64468759099998,41.16626582206506],[-113.64336787299999,41.166161515065035],[-113.64186083699998,41.165786217065055],[-113.63972826099996,41.16561646206505],[-113.63863981899999,41.16534456206507],[-113.63707200699999,41.165148098065075],[-113.63649625899997,41.16510280406506],[-113.63592051299996,41.16505750906505],[-113.63397265299994,41.164490195065035],[-113.63317534799995,41.16435014506506],[-113.63122651099998,41.16386387106504],[-113.63062331099997,41.16804504406503],[-113.63027127199994,41.16882368506504],[-113.62992810399999,41.17025605206504],[-113.62954855899994,41.171096037065],[-113.62907167699996,41.172583268065],[-113.62732515899995,41.171985605065046],[-113.626628886,41.17287615406501],[-113.626115154,41.172696487065004],[-113.62548308699996,41.172320329065016],[-113.62437340699995,41.17204380806503],[-113.62209427199996,41.17186116606501],[-113.62123440499994,41.17109290606503],[-113.61974151299997,41.168950729065045],[-113.61902516099997,41.169301959065024],[-113.61748246399998,41.17060759906501],[-113.61568750499997,41.17060653906503],[-113.61488989699995,41.16946003006501],[-113.614226354,41.169174480065],[-113.61376180099995,41.16867269006503],[-113.612834009,41.16784464206506],[-113.612696262,41.167468749065065],[-113.61263703499998,41.16705209206505],[-113.61203511199993,41.166187135065066],[-113.61123783099998,41.166046948065066],[-113.61027497599997,41.16400016406507],[-113.60912970699997,41.16466670806507],[-113.60695890399995,41.16733873306505],[-113.60638430999995,41.168610467065044],[-113.60626210899994,41.169466665065045],[-113.60571996199997,41.17033878206501],[-113.60494725599993,41.17180211106505],[-113.60444635799996,41.17244590106501],[-113.604286001,41.172593906065046],[-113.60321808999998,41.172283704065],[-113.60223130599995,41.172482942064995],[-113.60070896199994,41.17210291106504],[-113.59997315199996,41.17225226306503],[-113.59921639699996,41.17206268606501],[-113.59841907499997,41.17192241806502],[-113.59766673699994,41.17173328406505],[-113.59615997099996,41.171466046065056],[-113.59569650999997,41.17118981506502],[-113.59405045099999,41.170898291065036],[-113.59352099799997,41.17157688306502],[-113.59212759399999,41.171685701065016],[-113.59192935999992,41.17230326006499],[-113.59085056599997,41.17238742806499],[-113.59014188999997,41.172530812065],[-113.58866669999998,41.172024813065015],[-113.58792071099998,41.173436351065035],[-113.58732388099997,41.17529248206503],[-113.58680504399996,41.175774682065],[-113.58682132599996,41.17817163906502],[-113.58675129199996,41.179895880064976],[-113.58636270599999,41.18161227506499],[-113.586381841,41.184635012064966],[-113.585744816,41.18566077606497],[-113.58568865899998,41.18678035506495],[-113.58499170299997,41.18916688606496],[-113.58511703099998,41.19192886606495],[-113.58414648999997,41.19242703306494],[-113.58452978899997,41.193476954064934],[-113.58358976599999,41.19555865106491],[-113.583602537,41.19743005706493],[-113.58283816699998,41.19887817906492],[-113.58298093499995,41.200787946064885],[-113.58270450499998,41.20139719206489],[-113.58350468199995,41.20123477006488],[-113.58452739799998,41.20184220406489],[-113.58424187799994,41.20309806306491],[-113.58441972899998,41.20358235406487],[-113.58420753299998,41.204514926064874],[-113.58446040199998,41.20520602806489],[-113.58466485399997,41.20664931306489],[-113.58740171699998,41.208344123064876],[-113.58822200999998,41.20848877706488],[-113.58978962899994,41.208880874064846],[-113.59144220899998,41.20854655506486],[-113.59249043099997,41.21034633706488],[-113.59378468399996,41.20954535606483],[-113.59697187100001,41.20929556506485],[-113.59779029199994,41.21017737206489],[-113.59823361599996,41.210366988064884],[-113.59869833299996,41.210868853064866],[-113.59967254999998,41.21173748606485],[-113.60160027799998,41.212079324064845],[-113.60277390299994,41.212482476064835],[-113.60357169199996,41.21262272206483],[-113.60516619699997,41.21323988206482],[-113.60619373499996,41.21342160206482],[-113.60769248799993,41.21311914906486],[-113.61052693499994,41.21412905306486],[-113.61201813299999,41.21456350806487],[-113.61377812899997,41.21392745506487],[-113.61589884499995,41.21338062506485],[-113.61601118299996,41.21417223906484],[-113.61620381899996,41.21469706606481],[-113.61601554399998,41.21552418006482],[-113.61607226499996,41.21708928206484],[-113.61748371399993,41.21810457806482],[-113.61759157599992,41.21886700206484],[-113.61811316699999,41.21933214606481],[-113.61785444499998,41.219902833064815],[-113.61793067099994,41.22125542106482],[-113.61840834199994,41.220643574064816],[-113.62027228199999,41.22004407706482],[-113.62082892499997,41.21933068406481],[-113.62253410899997,41.21954458106479],[-113.62510429999999,41.219437647064815],[-113.62772084399995,41.22055856506484],[-113.62869015599995,41.2221263980648],[-113.62846711299993,41.2241491080648],[-113.62860565899996,41.225367362064766],[-113.62844194399997,41.225513732064805],[-113.62823609699996,41.22618571306479],[-113.62741663299992,41.22691981006481],[-113.62845842099996,41.2295404690648],[-113.62815484099998,41.230188800064774],[-113.62802196499996,41.23097947806476],[-113.62956552999998,41.23207321706475],[-113.63050068399998,41.233663948064766],[-113.62910217799998,41.235641813064774],[-113.62855487999997,41.23613134906474],[-113.62830634799995,41.23646420806477],[-113.62771472699995,41.23699399906473],[-113.62748496399996,41.23774173706475],[-113.62689332599996,41.23827152406476],[-113.62605818999998,41.23938693906471],[-113.62675845499997,41.24114890506471],[-113.62743689199999,41.24174023206469],[-113.62792507199998,41.24235594806473],[-113.62744827899996,41.243374561064705],[-113.62747781699993,41.24577320006473],[-113.62666062799997,41.24650589006468],[-113.62668214899998,41.24826555306469],[-113.62674868499994,41.24852893306468],[-113.62622702,41.24872305106471],[-113.62517128399998,41.24955607006466],[-113.62571648499994,41.25082312606468],[-113.62651002099993,41.25113749706468],[-113.62722633999998,41.25194083606469],[-113.62910352299998,41.25268462606469],[-113.63028699899996,41.25542730006467],[-113.63116572399997,41.256487044064635],[-113.63156025399998,41.25740126606464],[-113.63027977299998,41.25677774806464],[-113.62882585799996,41.256006918064685],[-113.62733425399995,41.25586438906467],[-113.62702408499996,41.25476160806469],[-113.62681404299998,41.25382806506465],[-113.62415995299996,41.25357378506468],[-113.62400158499999,41.25286735506465],[-113.62316283399996,41.252459152064695],[-113.62246422999999,41.251759831064696],[-113.61910211299994,41.251534877064664],[-113.61747682999999,41.24886330606472],[-113.61354721699996,41.24641788406467],[-113.61301307699995,41.24588094706469],[-113.61116256799995,41.2449798980647],[-113.61012453799997,41.2444289820647],[-113.60850467599992,41.24410071706469],[-113.60730307299997,41.24346392606471],[-113.606639429,41.2435669670647],[-113.60545830299999,41.24345449006474],[-113.60504401599998,41.24323312906474],[-113.60426163699998,41.24307578506475],[-113.60384735499998,41.24285442006473],[-113.60320680399997,41.242543139064736],[-113.60237681399998,41.24141261606471],[-113.60061203099997,41.241685922064704],[-113.59817460699998,41.241986771064745],[-113.59754528799998,41.24264091106474],[-113.59698703299993,41.243275574064704],[-113.59639258799994,41.24389183906473],[-113.59558422599997,41.2448083680647],[-113.59466878299997,41.24531166206471],[-113.59417564199997,41.24665398306469],[-113.59279033499996,41.24686904706471],[-113.59153991999995,41.246481725064726],[-113.590900698,41.24614144506467],[-113.58992716699997,41.24724490306471],[-113.58828197599998,41.246662184064704],[-113.58693959399994,41.245073547064706],[-113.58527396999995,41.24489300406471],[-113.58423644499999,41.24505429506469],[-113.58378377799994,41.2448339490647],[-113.58271736599994,41.24337837906469],[-113.58218900899999,41.24287462506473],[-113.58137663099996,41.24107277306471],[-113.58057444199994,41.24068269506475],[-113.58019490099998,41.239329723064756],[-113.58103107799997,41.23846056706474],[-113.58019763599998,41.23473091106474],[-113.57971103799997,41.23449504706474],[-113.578390443,41.23379365606474],[-113.57674877099997,41.23436155806474],[-113.576212081,41.23442763106477],[-113.57498545999998,41.23461727606475],[-113.57448063499997,41.234348784064764],[-113.57073477699998,41.23492892706475],[-113.56772183699997,41.234981175064775],[-113.56609880199996,41.23445586406473],[-113.56337506099997,41.234876766064765],[-113.56251575499999,41.23470325406476],[-113.56170164399998,41.234521332064745],[-113.55979611599996,41.23481574906475],[-113.55890353299998,41.23492583806473],[-113.55725786399995,41.23678893306475],[-113.55682059299993,41.23685709206472],[-113.55602631899997,41.23643490606474],[-113.55478122199997,41.236049739064754],[-113.55435069799994,41.23581984806475],[-113.55312399399996,41.23600928306473],[-113.55190320399998,41.23615954906472],[-113.55114432399994,41.23694958806476],[-113.55044229599997,41.237743445064716],[-113.54892856299995,41.237407213064714],[-113.54724352799995,41.23817984206475],[-113.54600188399996,41.23889732206474],[-113.54560865699995,41.23895826306476],[-113.54494256199996,41.23904001906474],[-113.54297236599996,41.239836166064755],[-113.54087742399997,41.242012608064705],[-113.54103622799995,41.24272427806474],[-113.54135457099994,41.24386532806473],[-113.53992586899993,41.24548186306471],[-113.53506294899995,41.246080506064686],[-113.53476356799996,41.24778744906468],[-113.53196064699995,41.24764993306468],[-113.53060673699999,41.247858878064676],[-113.52982146299996,41.247683392064694],[-113.52839576299999,41.24790332706471],[-113.52712525899996,41.24722856706467],[-113.52571202799997,41.24744674406469],[-113.52345233599999,41.2469430790647],[-113.51865225899995,41.2470499940647],[-113.51795961699996,41.24715763306473],[-113.51593740799996,41.24693720706473],[-113.51241911999995,41.24710170906469],[-113.51088702199996,41.246286271064726],[-113.50909330099994,41.247010538064686],[-113.50800890199997,41.24763660206469],[-113.50706298499993,41.246391798064685],[-113.506861733,41.24073789206475],[-113.50664810399998,41.237263227064766],[-113.50654113299998,41.23520808206473],[-113.50610871899993,41.233661172064735],[-113.50596455099996,41.23301776606474],[-113.50523634199998,41.23185146906474],[-113.50741240999997,41.23007019506477],[-113.50858089499997,41.22923761206479],[-113.50986376699997,41.225421613064775],[-113.50803855699996,41.2232583370648],[-113.50704274399997,41.22277331206482],[-113.50586187699997,41.22214460006477],[-113.50315369399998,41.22138550706479],[-113.50215874599995,41.22153812806482],[-113.50162208399995,41.22160388806481],[-113.50003634499996,41.2222694870648],[-113.50018516799997,41.21880438706485],[-113.50040948799995,41.216326525064815],[-113.50037298599993,41.212236525064824],[-113.50042745499996,41.20453083906491],[-113.50034537699997,41.201882466064916],[-113.50045124999995,41.200715757064906],[-113.50035240899997,41.19752030906493],[-113.50040188099995,41.19548832606495],[-113.500400669,41.18743484206497],[-113.50039784299999,41.183067716064954],[-113.50048982199996,41.17928478906499],[-113.50042921199997,41.177339417064985],[-113.50048470899996,41.17504577706498],[-113.50038711999997,41.16835690506502],[-113.50052634299998,41.168198146065045],[-113.50148468399999,41.167810951065015],[-113.51062829799999,41.15912408906506],[-113.51151449299999,41.15863819406507],[-113.51480088999995,41.15540157106512],[-113.525179715,41.14447111706516],[-113.52621894199997,41.14339208806513],[-113.53016036799994,41.142070019065166],[-113.53304197599998,41.13929140506515],[-113.53639468999995,41.138014618065164],[-113.54396567399998,41.133892415065176],[-113.54773586999995,41.13138389406521],[-113.54693321199993,41.13099177706521],[-113.54300440999998,41.130832699065195],[-113.53988685399997,41.1306779610652],[-113.53867532499999,41.1295802180652],[-113.54036508299998,41.12901333706521],[-113.540143877,41.12822313106524],[-113.53996770699997,41.12742986506523],[-113.53988608099998,41.127138810065226],[-113.53679730199997,41.126510470065256],[-113.53587096699998,41.1263037060652],[-113.53500401299999,41.12516981506522],[-113.53711489399996,41.12454768806523],[-113.53846153799998,41.124381965065226],[-113.53870043399998,41.123873907065246],[-113.53713964599997,41.1237222640652],[-113.53559653599996,41.123378624065225],[-113.53463524299997,41.122866872065266],[-113.53380984899997,41.12186989006527],[-113.534775923,41.12133966406524],[-113.53538456599995,41.120879293065265],[-113.53379529099999,41.120385536065264],[-113.53327381599998,41.11973285706527],[-113.53537469499997,41.11880335406527],[-113.54233369799998,41.11843197006527],[-113.55725187699994,41.11825811406527],[-113.56901112299992,41.11829740806524],[-113.57438849799996,41.11856171906527],[-113.57519880499994,41.117640734065276],[-113.5764956,41.11671378106524],[-113.57902183799997,41.11698821106529],[-113.58070325899995,41.118290659065266],[-113.58056051199998,41.119902462065276],[-113.57969062799998,41.12080835706523],[-113.57994917499997,41.121733908065245],[-113.58021365399999,41.12291632506523],[-113.58104543699996,41.12332122506522],[-113.58200541099997,41.12406499506525],[-113.58223439599998,41.12509476006524],[-113.58393584599997,41.12562240606521],[-113.58450366399995,41.12497790306523],[-113.58591497999998,41.125131699065236],[-113.58710533799994,41.12523213106524],[-113.589042142,41.12411261106521],[-113.58983010299994,41.123216986065216],[-113.59433003099996,41.12205123606524],[-113.59514623399997,41.122484847065245],[-113.59637382799995,41.121476793065234],[-113.59742747899998,41.121346993065266],[-113.59874998099995,41.120789968065246],[-113.60027444999997,41.12095551406524],[-113.60184454099999,41.120711092065264],[-113.60308837999997,41.12055792406527],[-113.60444240299996,41.12034785106526],[-113.60562976499996,41.120476207065266],[-113.60704297699999,41.120256787065266],[-113.60864871499994,41.12005735506527],[-113.60899488599995,41.119113502065254],[-113.61334359899996,41.11932584706528],[-113.61436478599997,41.121589014065236],[-113.615832535,41.12188688806524],[-113.61653507599998,41.12304440506526],[-113.61739536099998,41.12417458906523],[-113.61800206099997,41.12446905006524],[-113.61965359799996,41.12560916106521],[-113.62145939899995,41.12532841606522],[-113.62228753199997,41.12551315506524],[-113.62456462299996,41.12547222706521],[-113.62556184199995,41.12531705906522],[-113.62618916099997,41.12360440006527],[-113.62690457399998,41.123211673065235],[-113.62828278299999,41.123040564065235],[-113.62947547699997,41.12423929906524],[-113.63040932399996,41.12409400206522],[-113.63124954999996,41.12314069806521],[-113.63332870499994,41.12424437406523],[-113.63373642799998,41.12418104506523],[-113.63482982599999,41.12293783006524],[-113.63518250199995,41.12262233406526],[-113.63802879599997,41.12325457606524],[-113.63865694900001,41.12213062106523],[-113.63925000199998,41.12151422606523],[-113.63983498999994,41.12084890006523],[-113.642291566,41.12054400506524],[-113.64411926899997,41.120259851065256],[-113.64739184899997,41.12199632906525],[-113.64820816199993,41.122162320065264],[-113.64844329999993,41.12321253906524],[-113.64888691899996,41.12342742606521],[-113.64930064099997,41.12364862106526],[-113.65081292099995,41.12379292806522],[-113.65274729499997,41.1244181570652],[-113.65413202299997,41.12361537606526],[-113.65706207899997,41.12393198706521],[-113.65770888999998,41.123557177065244],[-113.65942164399995,41.12363926806526],[-113.66017417699999,41.12439666806526],[-113.66277577899996,41.123300030065224],[-113.66432249099995,41.12346705306525],[-113.66561040799996,41.12415059106522],[-113.66770912399993,41.12625749906523],[-113.66928601199997,41.12601128006522],[-113.67088454499998,41.12636588306522],[-113.67228522799996,41.12614748206524],[-113.67402334199994,41.12679350406525],[-113.674779045,41.12719468006521],[-113.67652132599993,41.126923089065215],[-113.67774676499994,41.1273191950652],[-113.67947244599998,41.127049887065205],[-113.68025536799998,41.12722462906522],[-113.68105737399998,41.12737858806521],[-113.68146425999998,41.1269158240652]]]]},"geometry_name":"the_geom","properties":{"ogc_fid":2198748,"gridcode":1981614,"featureid":1174228,"sourcefc":"NHDFlowline","areasqkm":143.418738,"shape_length":0.909144994925489,"shape_area":0.0153901346296202}}],"crs":{"type":"name","properties":{"name":"urn:ogc:def:crs:EPSG::4326"}}}'''
            
            
            startpoint = json.loads(startpoint)
            outsrid = int(outsrid)
            maskjson = json.loads(maskjson)

            arcpy.AddMessage("startpoint {0}.".format(startpoint))
            arcpy.AddMessage("outsrid {0}.".format(outsrid))
            arcpy.AddMessage("maskjson {0}.".format(maskjson))

            startTime = time.time()
            
            config = Config(json.load(open(os.path.join(os.path.dirname(__file__), 'config.json'))))  
            workingDir = Shared.GetWorkspaceDirectory(config["workingdirectory"],"fdrtrace") 
            
            WiMLogging.init(os.path.join(workingDir,"Temp"),"fldr.log")
            self._sm("Start routine")
            
            sr = arcpy.SpatialReference(outsrid)           
            spoint = arcpy.CreateFeatureclass_management("in_memory", "ppointFC", "POINT", spatial_reference=sr) 
            if (startpoint["type"].lower() =="feature"):
                GeoJsonHandler.read_feature(startpoint,spoint,sr)
            else:
                GeoJsonHandler.read_feature_collection(startpoint,spoint,sr)  

            if(maskjson):
                mask = arcpy.CreateFeatureclass_management("in_memory", "maskFC", "POLYGON", spatial_reference=sr) 
                if (maskjson["type"].lower() =="feature"):
                    GeoJsonHandler.read_feature(maskjson, mask,sr)
                else:
                    GeoJsonHandler.read_feature_collection(maskjson,mask,sr)             
            
            with FlowDirectionTrace(workingDir) as fdrTrace:
                if (not fdrTrace.isInit): raise Exception('FlowDirectionTrace failed to initialize')
                traceline = fdrTrace.Trace(spoint, mask)
            #end with
            
            if(not traceline): raise Exception ("TraceFailed")

            resulttrace = traceline.projectAs(sr)
            self._sm('Finished.  Total time elapsed:'+ str(round((time.time()- startTime)/60, 2))+ 'minutes')

            Results = json.dumps({
                       "trace": self.geometry_to_struct( resulttrace),
                       "Message": ';'.join(WiMLogging.LogMessages).replace('\n',' ')
                      })
        except:
             tb = traceback.format_exc()
             arcpy.AddMessage("Error "+tb)
             self._sm( "Error executing wrapper "+tb,"Error")
             Results = json.dumps( {
                        "error": {"message": ';'.join(WiMLogging.LogMessages).replace('\n',' ')}
                       })
        finally:
            self._sm(Results)            
            
            arcpy.SetParameterAsText(3, Results)
              
    
    def geometry_to_struct(self, in_geometry):
        if in_geometry is None:
            return None
        elif isinstance(in_geometry, arcpy.PointGeometry):
            pt = in_geometry.getPart(0)
            return {
                        'type': "Point",
                        'coordinates': (pt.X, pt.Y)
                   }
        elif isinstance(in_geometry, arcpy.Polyline):
            parts = [[(point.X, point.Y) for point in in_geometry.getPart(part)]
                     for part in xrange(in_geometry.partCount)]
            if len(parts) == 1:
                return {
                            'type': "LineString",
                            'coordinates': parts[0]
                       }
            else:
                return {
                            'type': "MultiLineString",
                            'coordinates': parts
                       }
        elif isinstance(in_geometry, arcpy.Polygon):
            parts = [list(part_split_at_nones(in_geometry.getPart(part)))
                     for part in xrange(in_geometry.partCount)]
            if len(parts) == 1:
                return {
                            'type': "Polygon",
                            'coordinates': parts[0]
                       }
            else:
                return {
                            'type': "MultiPolygon",
                            'coordinates': parts
                       }
        else:
            raise ValueError(in_geometry)
    def _sm(self,msg,type="INFO", errorID=0):        
        WiMLogging.sm(msg,type="INFO", errorID=0)

if __name__ == '__main__':
    #sys.argv[0] is reserved for the running script name
    TraceWrapperScript()
    

